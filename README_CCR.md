##Функциональный блок CCR - Crawler_Calculation_Rule

Файлы приложения:
crawler_calc_rule.php - обходчик (он же контроллер приложения);
crawler_blogic_function.php - содержит функции бизнес-логики;
crawler_db_function.php - содержит функции для работы с хранилищами (базами данных, etc)

Консольное приложение которое может запускаться в 2-режимах:
- ручной запуск
- запуск без параметров

###Ручной запуск
В режиме ___"Ручной запуск"___ принимает следующие параметры:
```
-h | --help
```
- выводит справку об использовании программы:
```

Для запуска скрипта используйте следующий формат:
crawler_cal_rule [-h | --help] | [dd/mm/yyyy id_rule] | [-p | --process]

	-h | --help	:вывод текущей справки
	dd/mm/yyyy	:день/месяц/год за который произвести расчет
	rule_id		:идентификатор правила для расчета (numeric)
	-p | --process	:вывод правил в состоянии 'in_process_calculation...'
```

или
```
-p | --process - выводит список правил расчета
```
- выводит список правил расчета в состоянии 'in_progress_calculation...'

```
Список правил расчета, находящихся в состоянии 'in_process_calculation...' по состоянию на 2021-07-02 14:06:42
|------------------------------------------------------------------------------------------------------------|
| rule_id | object_type | object_id |  last_updated_time  | last_calculated_date |          rule_name        |
|------------------------------------------------------------------------------------------------------------|
|      30 |         bms |       142 | 2021-07-02 12:49:17 |  1970-01-01 05:00:00 | calculation_rule_bms8     |
|       2 |   apartment |    787036 | 2021-07-02 13:47:57 |  2021-06-30 14:04:38 | calculation_rule_2        |
|------------------------------------------------------------------------------------------------------------|
```
или

```
{path_to_file}/crawler_calc_rule.php 16/7/2021 46
```
где, 
первый параметр это дата расчета в формате dd/mm/yyyy - (string) обходчик будет использовать архивные данные за указанное число;
второй параметр это номер правила - (integer) ИД правила расчета

Будет запущен обработчик, который в соответствии с правилом 7 обработает архивные данные за 12 июня 2021 года.
После обработки архивных данных, результат будет помещен в архивную таблицу за 12 июня 2021 года.
Номер правила, при этом, будет зафиксирован в архивной таблице в поле номер сигнала (signal_id) в виде отрицательного числа (-7).

###Запуск запуск без параметров

В режиме ___"Запуск без параметров"___ действует следующая схема работы:
    - обходчик выбирает из таблицы правил те, у которых время следующего расчета меньше текущего времени, и составляет список;
    - затем из списка выбирается правило и начинается его обработка:
        1. в поле __calculation_rule_status__ записывается значение 'in_progress_calculation...';
        2. производится обработка правила в соответствии с object_type+object_id+type_signal+tags_device+tags_signal+time_period
        3. если результат обработки правила не равен ___false___, сохраняем результаты в соответствующей таблице;
            - при успешном сохранении поле __calculation_rule_status__ будет иметь значение 'waiting calculation...', 
                поле 'last_calculated_date' - текущее время (время записи), 
                поле 'next_calculated_date' - дату следующего расчета
        при выполнении пункта 3 производится документирование операций посредством 
        CrawlerLogger::saveMessageToLog({номер_правила}, {имя_метода}, {результат_операции})
        Пример лога:
```
    [2021-06-30 14:04:47 +05:00] - [ SUCCESS ]:Операция: d_executeCalculationRule() при работе с calculation_rule = 29
    [2021-06-30 14:04:48 +05:00] - [ SUCCESS ]:Операция: d_saveResultInArchive() при работе с calculation_rule = 29
    [2021-06-30 14:04:48 +05:00] - [ FAIL ]:Операция: d_executeCalculationRule() при работе с calculation_rule = 30
    [2021-06-30 14:04:48 +05:00] - [ FAIL ]:Операция: d_saveResultInArchive() при работе с calculation_rule = 30
    [2021-06-30 14:04:48 +05:00] - [ SUCCESS ]:Операция: d_executeCalculationRule() при работе с calculation_rule = 17
    [2021-06-30 14:04:49 +05:00] - [ SUCCESS ]:Операция: d_saveResultInArchive() при работе с calculation_rule = 17

```
Соответственно, для правил у которых в логе зафиксировано [ FAIL ], поле calculation_rule_status имеет значение ___'in_progress_calculation...'___ 